<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>E-Simulator Roleplay (Saving 1)</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; padding: 20px; text-align: center; background-color: #f4f7f6; }
        .container-box { max-width: 700px; margin: 0 auto; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08); }
        h1 { font-size: 32px; color: #d9534f; margin-bottom: 20px; }
        h2 { margin-top: 25px; font-size: 24px; color: #337ab7; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        button { margin: 10px 5px; padding: 12px 24px; font-size: 18px; cursor: pointer; border-radius: 8px; border: none; transition: background-color 0.3s; }
        .status-text { margin-top: 15px; font-weight: bold; font-size: 1.1em; }
        .success-text { color: green; }
        .error-text { color: red; }
        .audio-player { width: 100%; max-width: 400px; margin: 15px auto; }
        .section-content { text-align: left; padding: 10px; border: 1px dashed #ccc; border-radius: 8px; margin-top: 15px; }
        .hide { display: none; }
    </style>
</head>
<body>
    <div class="container-box">
        <h1>E-Simulator Roleplay (Saving 1)</h1>

        <div id="registrationSection">
            <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
            <div style="text-align: left; margin-bottom: 10px;">
                <label for="inputUserName">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label>
                <input type="text" id="inputUserName" readonly style="width:100%; padding: 8px;">
            </div>
            <div style="text-align: left; margin-bottom: 20px;">
                <label for="inputUserGroup">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô/‡∏ó‡∏µ‡∏°:</label>
                <input type="text" id="inputUserGroup" readonly style="width:100%; padding: 8px;">
            </div>

            <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å</h2>
            <div style="display: flex; justify-content: center; gap: 20px;">
                <label><input type="radio" name="difficulty" value="EASY" checked> ‡∏á‡πà‡∏≤‡∏¢</label>
                <label><input type="radio" name="difficulty" value="MEDIUM"> ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</label>
                <label><input type="radio" name="difficulty" value="HARD"> ‡∏¢‡∏≤‡∏Å</label>
            </div>
            <button id="startTestBtn" style="margin-top: 20px;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏™‡∏°‡∏°‡∏ï‡∏¥</button>
        </div>

        <div id="testSection" class="hide">
            <p>‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏£‡∏ß‡∏°: <span id="currentTurnSpan">0</span>/<span id="maxTurnSpan">0</span> | Q: <span id="currentQSpan">0</span>/<span id="maxQSpan">0</span> | C: <span id="currentCSpan">0</span>/<span id="maxCSpan">0</span> | A: <span id="currentASpan">0</span>/<span id="maxASpan">0</span></p>

            <div id="section1Div" class="hide">
                <h2>‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏ö‡∏ó‡∏û‡∏π‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h2>
                <p id="s1StatusElement" class="status-text"></p>
                <audio id="s1AudioPlayer" class="audio-player" controls></audio>
                <button id="recordBtn">üé§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà <span id="currentS1Turn">1</span>)</button>
                <div id="s1RecordingStatus" class="status-text error-text"></div>
            </div>

            <div id="section1_5Div" class="hide">
                <h2>‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1.5: ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö</h2>
                <p>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏π‡∏î‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡∏û‡∏π‡∏î‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö</p>
                <button id="nextSection2Btn" disabled>‚ñ∂Ô∏è ‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
            </div>
            
            <div id="section2Div" class="hide">
                <h2>‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°/‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</h2>
                <p id="s2QuestionElement" class="section-content">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</p>
                <p id="s2StatusElement" class="status-text"></p>
                <audio id="s2AudioPlayer" class="audio-player" controls></audio>
                <button id="answerQBtn">üé§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <div id="s2RecordingStatus" class="status-text error-text"></div>
            </div>

            <div id="section3Div" class="hide">
                <h2>‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h2>
                <p id="s3ObjectionElement" class="section-content">‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á:</p>
                <p id="s3StatusElement" class="status-text"></p>
                <audio id="s3AudioPlayer" class="audio-player" controls></audio>
                <button id="answerCBtn">üé§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <div id="s3RecordingStatus" class="status-text error-text"></div>
            </div>

            <div id="section5Div" class="hide">
                <h2>‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 5: ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠</h2>
                <p id="s5ScriptElement" class="section-content">‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå:</p>
                <p id="s5StatusElement" class="status-text"></p>
                <audio id="s5AudioPlayer" class="audio-player" controls></audio>
                <button id="answerABtn">üé§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <div id="s5RecordingStatus" class="status-text error-text"></div>
            </div>

            <div id="finalSection" class="hide" style="margin-top: 30px;">
                <h2>‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏™‡∏°‡∏°‡∏ï‡∏¥</h2>
                <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                <button id="finalSaveBtn" style="background-color: #28a745;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <p id="saveStatus" class="status-text"></p>
                <button id="certBtn" class="hide" style="background-color: #ffc107;">üèÜ ‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏ú‡∏•</button>
            </div>
            
            <div id="certificate" class="hide" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; justify-content: center; align-items: center;">
                <div style="background: white; padding: 40px; border-radius: 10px; max-width: 80%; text-align: center;">
                    <h3>‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏ú‡∏•</h3>
                    <p>‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</p>
                    <button onclick="document.getElementById('certificate').style.display='none'">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>

        </div>
    </div>


    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // ‚ö†Ô∏è Config: Supabase Key ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤
        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno';
        window.supabase = createClient(supabaseUrl, supabaseKey);

        // --- Multi-Product Configuration (NEW) ---
        const DEFAULT_PRODUCT_TAG = 'saving1'; // <--- Product Tag: saving1
        const CURRENT_PRODUCT_TAG = localStorage.getItem('roleplaySelectedProductTag') || DEFAULT_PRODUCT_TAG;
        const FILTER_TAGS = [CURRENT_PRODUCT_TAG]; // ‡πÅ‡∏¢‡∏Å Product ‡πÇ‡∏î‡∏¢‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î

        const NO_ANSWER_URL = "..."; 
        let productDisplayName = '';

        // Variables: ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ S4 ‡∏≠‡∏≠‡∏Å
        let allRecordings = [], mediaRecorder = null, currentUserId = null;
        let turn=0, qRound=0, cRound=0, aRound=0;
        let maxTurns, maxQ, maxC, maxA;
        let globalConfig={}, globalS1Files=[], globalS2Files=[], globalS3Files=[], globalS5Steps=[]; // ‡πÑ‡∏°‡πà‡∏°‡∏µ S4
        let audioCache={}, selectedRandomFiles=[], lastCustomerAudioUrl='N/A';
        let selectedS2Files = [], selectedS3Files = [];
        
        // --- Core Functions: fetchInitialData (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏•‡∏ö S4 ‡∏≠‡∏≠‡∏Å) ---

        const fetchInitialData = async function() {
            try {
                // 1. ‡∏î‡∏∂‡∏á Difficulty Config - ‡πÑ‡∏°‡πà‡∏°‡∏µ S4
                const { data: cData, error: cError } = await window.supabase
                    .from('difficulty_config')
                    .select('*');
                if (cError) throw cError;
                cData.forEach(c => globalConfig[c.difficulty_level] = { S1: c.max_s1, S2: c.max_s2, S3: c.max_s3, S5: c.max_s5 });

                // 2. ‡∏î‡∏∂‡∏á S1 (customer_replies_s1)
                const { data: s1Data, error: s1Error } = await window.supabase
                    .from('customer_replies_s1')
                    .select('turn_index, audio_url, is_finale')
                    .overlaps('product_type', FILTER_TAGS) 
                    .order('turn_index', { ascending: true });
                if (s1Error) throw s1Error;
                globalS1Files = s1Data;

                // 3. ‡∏î‡∏∂‡∏á S2 (questions_s2)
                const { data: s2Data, error: s2Error } = await window.supabase
                    .from('questions_s2')
                    .select('q_index, audio_url')
                    .overlaps('product_type', FILTER_TAGS) 
                    .order('q_index', { ascending: true });
                if (s2Error) throw s2Error;
                globalS2Files = s2Data;

                // 4. ‡∏î‡∏∂‡∏á S3 (objections_s3)
                const { data: s3Data, error: s3Error } = await window.supabase
                    .from('objections_s3')
                    .select('c_index, audio_url')
                    .overlaps('product_type', FILTER_TAGS) 
                    .order('c_index', { ascending: true });
                if (s3Error) throw s3Error;
                globalS3Files = s3Data;
                
                // 5. ‡∏î‡∏∂‡∏á S5 (scripts_s5)
                const { data: s5Data, error: s5Error } = await window.supabase
                    .from('scripts_s5')
                    .select('a_index, audio_url')
                    .overlaps('product_type', FILTER_TAGS) 
                    .order('a_index', { ascending: true });
                if (s5Error) throw s5Error;
                globalS5Steps = s5Data;

                return true;
            } catch (error) {
                console.error("Error fetching data:", error);
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏î‡πâ: " + error.message);
                return false;
            }
        };

        const initializeUserAndDOM = async function() {
            // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà) ...

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠ Product ‡∏ö‡∏ô UI (NEW)
            productDisplayName = (CURRENT_PRODUCT_TAG === 'health') ? '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û' :
                                (CURRENT_PRODUCT_TAG === 'saving1') ? '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå 1' :
                                (CURRENT_PRODUCT_TAG === 'saving2') ? '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå 2' :
                                (CURRENT_PRODUCT_TAG === 'retirement') ? '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì' : 'Simulator';
                                
            document.querySelector('h1').textContent = `E-Simulator Roleplay (${productDisplayName})`;
            
            // ... (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏ß‡πâ) ...
        };

        document.addEventListener('DOMContentLoaded', initializeUserAndDOM);
        
        // ... (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: init, toggleRecording, prepareTurnFiles, nextTurn, initSection2, etc. ‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà) ...
    </script>
</body>
</html>
