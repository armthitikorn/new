<div id="testSection" style="display: none;">
    <h2>สถานะการทดสอบ</h2>
    <p>เทิร์นรวม: <span id="turnSpan">1</span>/<span id="maxTurnSpan">5</span> | Q: <span id="qRound">1</span>/<span id="maxQSpan">10</span> | C: <span id="cRound">1</span>/<span id="maxCSpan">5</span> | A: <span id="aRound">1</span>/<span id="maxASpan">7</span></p>

    </div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    import { v4 as uuidv4 } from 'https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/esm-browser/index.js';

    // --- 1. Supabase Config & Global State ---
    const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
    window.supabase = createClient(supabaseUrl, supabaseKey);

    // --- Multi-Product Configuration (NEW) ---
    const DEFAULT_PRODUCT_TAG = 'saving1'; // <--- Product Tag: saving1
    const CURRENT_PRODUCT_TAG = localStorage.getItem('roleplaySelectedProductTag') || DEFAULT_PRODUCT_TAG;
    const FILTER_TAGS = [CURRENT_PRODUCT_TAG]; // แยก Product โดยเด็ดขาด

    // Variables: ลบตัวแปร S4 ออก
    let mediaRecorder = null; let currentUserId = null; let allRecordings = []; let lastCustomerAudioUrl = 'N/A';
    let turn=0, qRound=0, cRound=0, aRound=0; // ลบ currentHIndex, isFollowUpMode, followUpStep, selectedDisease
    let maxTurns, maxQ, maxC, maxA; // ลบ maxH, maxFollowUp
    let globalConfig={}, globalS1Files=[], globalS2Files=[], globalS3Files=[], globalS5Steps=[]; // ลบ globalS4...
    let audioCache={}, selectedRandomFiles=[], selectedS2Files = [], selectedS3Files = [];
    const NO_ANSWER_URL = "..."; 

    // --- Core Functions: fetchInitialData (ปรับปรุงการกรองและลบ S4) ---
    const fetchInitialData = async function() {
        window.loadingOverlay.style.display = "flex";
        try {
            // 1. ดึง Difficulty Config - ลบ S4 ออก
            const { data: cData, error: cError } = await window.supabase
                .from('difficulty_config')
                .select('*');
            if (cError) throw cError;
            cData.forEach(c => globalConfig[c.difficulty_level] = { S1: c.max_s1, S2: c.max_s2, S3: c.max_s3, S5: c.max_s5 });

            // 2. ดึง S1 (customer_replies_s1)
            const { data: s1Data, error: s1Error } = await window.supabase.from('customer_replies_s1').select('*').overlaps('product_type', FILTER_TAGS).order('turn_index');
            if (s1Error) throw s1Error; globalS1Files = s1Data;
            
            // 3. ดึง S2 (questions_s2)
            const { data: s2Data, error: s2Error } = await window.supabase.from('questions_s2').select('*').overlaps('product_type', FILTER_TAGS).order('q_index');
            if (s2Error) throw s2Error; globalS2Files = s2Data;

            // 4. ดึง S3 (objections_s3)
            const { data: s3Data, error: s3Error } = await window.supabase.from('objections_s3').select('*').overlaps('product_type', FILTER_TAGS).order('ob_index');
            if (s3Error) throw s3Error; globalS3Files = s3Data;
            
            // 5. ดึง S5 (scripts_s5)
            const { data: s5Data, error: s5Error } = await window.supabase.from('scripts_s5').select('*').overlaps('product_type', FILTER_TAGS).order('step_index');
            if (s5Error) throw s5Error; globalS5Steps = s5Data;

            // ... (ละไว้: preloadCriticalAudio และส่วนอื่นๆ)
            window.loadingOverlay.style.display = "none";
            return true;
        } catch (error) {
            alert("โหลดข้อมูลไม่สำเร็จ: " + error.message);
            window.loadingOverlay.style.display = "none";
            return false;
        }
    };
    
    // --- Initialization and Event Listeners (แก้ไข Auto Fill) ---
    const initializeUserAndDOM = async function() {
        // ... (ส่วนการกำหนด ID และ DOM Element เดิม) ...
        // ส่วนนี้ต้องคงโค้ดเดิมของคุณไว้ (binding buttons)
        
        // NEW LOGIC: ดึงข้อมูลชื่อ/กลุ่ม จาก Local Storage
        const storedUserData = localStorage.getItem('roleplayUserData');

        if (storedUserData) {
            try {
                const userData = JSON.parse(storedUserData);
                window.inputUserName.value = userData.fullName || '';
                window.inputUserGroup.value = userData.department || '';
            } catch (e) {
                console.error("Error parsing user data from localStorage:", e);
            }
        }
        
        // ... (ส่วน Event Listeners และ startTest เดิม) ...
        
        const dataLoaded = await fetchInitialData();
        if (!dataLoaded) {
            window.startTestBtn.disabled = true;
            window.startTestBtn.textContent = "❌ ไม่สามารถโหลดข้อมูลได้";
        }
    }

    document.addEventListener('DOMContentLoaded', initializeUserAndDOM);
    
    // ... (กรุณาคงฟังก์ชันหลักอื่นๆ ทั้งหมด: init, toggleRecording, prepareTurnFiles, nextTurn, initSection2, etc. ไว้ที่นี่) ...
</script>
