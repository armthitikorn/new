<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>E-Simulator Roleplay (Saving 1)</title>
    <style>
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì */
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; padding: 20px; text-align: center; background-color: #f4f7f6; }
        .container-box { max-width: 700px; margin: 0 auto; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08); }
        h1 { font-size: 32px; color: #d9534f; margin-bottom: 20px; }
        h2 { margin-top: 25px; font-size: 24px; color: #337ab7; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        button { margin: 10px 5px; padding: 12px 24px; font-size: 18px; cursor: pointer; border-radius: 8px; border: none; transition: background-color 0.3s; }
        button:hover:not(:disabled) { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        #finalSaveBtn { background-color: #007bff; color: white; font-weight: bold; }
        #finalSaveBtn.done { background-color: #28a745; }
        .form-control { padding: 10px; border: 1px solid #ccc; border-radius: 6px; width: 100%; max-width: 400px; margin-top: 5px; text-align: center; font-size: 16px; }
        .difficulty-option { display: inline-block; margin: 8px; cursor: pointer; padding: 10px 20px; border: 2px solid #ccc; border-radius: 20px; }
        input[type="radio"]:checked + .difficulty-option { background-color: #337ab7; color: white; border-color: #337ab7; font-weight: bold; }
        input[type="radio"] { display: none; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); color: white; display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 1000; }
        .spinner-border { width: 3rem; height: 3rem; border: 0.25em solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spinner-border 0.75s linear infinite; }
        @keyframes spinner-border { to { transform: rotate(360deg); } }
        .progress { width: 80%; max-width: 400px; margin-top: 20px; height: 15px; background-color: #e9ecef; border-radius: 0.25rem; overflow: hidden; }
        .progress-bar { height: 100%; background-color: #007bff; transition: width 0.6s ease; }
        #certificate { border: 5px solid #333; padding: 40px; width: 90%; max-width: 800px; margin: 40px auto; text-align: center; display: none; }
    </style>
</head>
<body>
    <div id="loadingOverlay">
        <div class="spinner-border text-light" role="status"></div>
        <h5 id="loadingText" class="mt-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£...</h5>
        <div class="progress"><div id="uploadProgressBar" class="progress-bar" style="width: 0%"></div></div>
    </div>

    <div class="container-box">
        <h1>E-Simulator Roleplay (Saving 1)</h1>
        
        <div id="registrationSection">
            <h2>üìù ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°</h2>
            <div style="margin-bottom: 20px;">
                <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•/‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
                <input type="text" class="form-control" id="inputUserName" required>
            </div>
            <div style="margin-bottom: 20px;">
                <label>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</label>
                <input type="text" class="form-control" id="inputUserGroup" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°/‡πÅ‡∏ú‡∏ô‡∏Å">
            </div>
            <div style="margin-bottom: 30px;">
                <label>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å:</label><br>
                <input type="radio" id="diffEasy" name="difficulty" value="easy" checked><label for="diffEasy" class="difficulty-option">‡∏á‡πà‡∏≤‡∏¢ (Easy)</label>
                <input type="radio" id="diffHard" name="difficulty" value="hard"><label for="diffHard" class="difficulty-option">‡∏¢‡∏≤‡∏Å (Hard)</label>
                <input type="radio" id="diffHarder" name="difficulty" value="harder"><label for="diffHarder" class="difficulty-option">‡∏¢‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô (Harder)</label>
            </div>
            <button id="startTestBtn" style="background-color: #28a745; color: white;">‚ñ∂Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
        </div>
        
        <div id="testSection" style="display: none;">
            <h2>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h2>
            <p>‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏£‡∏ß‡∏°: <span id="turnSpan">1</span>/<span id="maxTurnSpan">5</span> | Q: <span id="qRound">1</span>/<span id="maxQSpan">10</span> | C: <span id="cRound">1</span>/<span id="maxCSpan">5</span> | A: <span id="aRound">1</span>/<span id="maxASpan">7</span></p>

            <div id="section1Div">
                <h2>üó£Ô∏è ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß (T<span id="turnSpan">1</span>/<span id="maxTurnSpan">5</span>)</h2>
                <audio id="customerAudio"></audio>
                <button id="recordBtn">üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
                <button disabled id="nextRoundBtn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1</button>
                <p id="status">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>
            </div>
            <div id="section1_5Div" style="display: none;">
                <h2>üõí ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1.5: ‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠ (Pitch)</h2>
                <button disabled id="pitchRecordBtn">üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠</button>
                <button disabled id="nextSection2Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1.5</button>
                <p id="pitchStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>
            </div>
            <div id="section2Div" style="display: none;">
                <h2>‚ùì ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (Q<span id="qRound">1</span>/<span id="maxQSpan">10</span>)</h2>
                <audio id="questionAudio"></audio>
                <button disabled id="startQBtn">üîä ‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡πÄ‡∏£‡∏¥‡πà‡∏°)</button>
                <button disabled id="answerBtn">üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
                <button disabled id="nextSection3Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2</button>
                <p id="qStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>
            </div>
            <div id="section3Div" style="display: none;">
                <h2>üí∞ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3: ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡∏£‡∏≠‡∏ö <span id="cRound">1</span>/<span id="maxCSpan">5</span>)</h2>
                <button disabled id="closeBtn">üéôÔ∏è 1. ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
                <audio id="objectionAudio"></audio>
                <button disabled id="replyBtn">üéôÔ∏è 2. ‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á</button>
                <button disabled id="nextSection5Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3</button> 
                <p id="cStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>
            </div>
            
            <div id="section5Div" style="display: none;">
                <h2>ü§ù ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Step <span id="aRound">1</span>/<span id="maxASpan">7</span>)</h2>
                <audio id="agreementAudio"></audio>
                <div id="registrationStepsDisplay" style="text-align: left; padding: 15px; background:#f8f9fa;">
                    <ol id="stepList"></ol>
                </div>
                <button disabled id="answerABtn">üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button> 
                <button disabled id="finalSaveBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
                <p id="aStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>
            </div>
            <div id="certificate">
                <h1>‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡∏¢‡∏ö‡∏±‡∏ï‡∏£</h1><h2 id="traineeName"></h2>
                <p>‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ó‡∏≤‡∏á‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</p>
                <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="issueDate"></span></p>
            </div>
            <button id="certBtn">üéì ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        import { v4 as uuidv4 } from 'https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/esm-browser/index.js';

        // ‚ö†Ô∏è Config: Supabase Key ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤
        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
        window.supabase = createClient(supabaseUrl, supabaseKey);

        // --- Multi-Product Configuration (NEW) ---
        const DEFAULT_PRODUCT_TAG = 'retirement'; // <--- Product Tag ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö retirement
        const CURRENT_PRODUCT_TAG = localStorage.getItem('roleplaySelectedProductTag') || DEFAULT_PRODUCT_TAG;
        const FILTER_TAGS = [CURRENT_PRODUCT_TAG]; // ‡πÅ‡∏¢‡∏Å Product ‡πÇ‡∏î‡∏¢‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î

        const NO_ANSWER_URL = "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q3/health5_P1_P1Q3_1762340907852.webm"; 
        let productDisplayName = ''; // ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠ Product ‡∏ö‡∏ô UI

        // Variables (‡∏•‡∏ö S4 ‡∏≠‡∏≠‡∏Å)
        let allRecordings = [], mediaRecorder = null, currentUserId = null;
        let turn=0, qRound=0, cRound=0, aRound=0;
        let maxTurns, maxQ, maxC, maxA; // ‡πÑ‡∏°‡πà‡∏°‡∏µ maxH, maxFollowUp
        let globalConfig={}, globalS1Files=[], globalS2Files=[], globalS3Files=[], globalS5Steps=[]; // ‡πÑ‡∏°‡πà‡∏°‡∏µ S4 files
        let audioCache={}, selectedRandomFiles=[], lastCustomerAudioUrl='N/A';
        let selectedS2Files = [], selectedS3Files = []; 
        
        // --- Helpers --- (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô shuffleArray, playAudio, etc. ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°)
        const shuffleArray = (array) => {
            let currentIndex = array.length, randomIndex;
            let newArray = [...array]; 
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [newArray[currentIndex], newArray[randomIndex]] = [newArray[randomIndex], newArray[currentIndex]];
            }
            return newArray;
        }

        const playAudio = (url, statusEl, onEnd) => {
            const audio = new Audio(url);
            statusEl.textContent = "üîä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á...";
            audio.play().then(() => {
                statusEl.textContent = "üîä ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...";
            }).catch(e => { statusEl.textContent = "‚ùå ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô"; });
            audio.onended = onEnd;
        };
        
        const preloadCriticalAudio = () => { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î Preload ‡πÄ‡∏î‡∏¥‡∏° ... */ };
        
        const storeRecording = (audioBlob, part, qNum, qText, customerAudioUrl = 'N/A') => { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î Store Recording ‡πÄ‡∏î‡∏¥‡∏° ... */ };
        const uploadAllRecordings = async () => { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î Upload All ‡πÄ‡∏î‡∏¥‡∏° ... */ };
        
        const getCachedAudioElement = (url, fallbackToNew = true) => { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î Get Cached Audio ‡πÄ‡∏î‡∏¥‡∏° ... */ };
        const renderRegSteps = () => { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î renderRegSteps ‡πÄ‡∏î‡∏¥‡∏° ... */ };
        const hideAll = () => ['section1Div','section1_5Div','section2Div','section3Div','section5Div'].forEach(id=>document.getElementById(id).style.display='none');

        // --- Core Functions: fetchInitialData (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏•‡∏ö S4) ---
        const fetchInitialData = async function() {
            window.loadingOverlay.style.display = "flex";
            window.loadingText.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...`;

            try {
                // 1. ‡∏î‡∏∂‡∏á Config - ‡∏•‡∏ö S4 ‡∏≠‡∏≠‡∏Å
                const { data: cData, error: cError } = await window.supabase
                    .from('difficulty_config')
                    .select('*');
                if (cError) throw cError;
                cData.forEach(c => globalConfig[c.difficulty_level] = { S1: c.max_s1, S2: c.max_s2, S3: c.max_s3, S5: c.max_s5 });

                // 2. ‡∏î‡∏∂‡∏á S1 (customer_replies_s1)
                window.loadingText.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏™‡∏≤‡∏¢... (${CURRENT_PRODUCT_TAG})`;
                const { data: s1Data, error: s1Error } = await window.supabase
                    .from('customer_replies_s1')
                    .select('turn_index, audio_url, is_finale')
                    .overlaps('product_type', FILTER_TAGS) // <-- FILTERED
                    .order('turn_index', { ascending: true });
                if (s1Error) throw s1Error;
                globalS1Files = s1Data;
                
                // 3. ‡∏î‡∏∂‡∏á S2 (questions_s2)
                const { data: s2Data, error: s2Error } = await window.supabase
                    .from('questions_s2')
                    .select('q_index, audio_url')
                    .overlaps('product_type', FILTER_TAGS) // <-- FILTERED
                    .order('q_index', { ascending: true });
                if (s2Error) throw s2Error;
                globalS2Files = s2Data;

                // 4. ‡∏î‡∏∂‡∏á S3 (objections_s3)
                const { data: s3Data, error: s3Error } = await window.supabase
                    .from('objections_s3')
                    .select('ob_index, audio_url')
                    .overlaps('product_type', FILTER_TAGS) // <-- FILTERED
                    .order('ob_index', { ascending: true });
                if (s3Error) throw s3Error;
                globalS3Files = s3Data;
                
                // ‚ö†Ô∏è ‡∏•‡∏ö S4 data fetches ‡∏≠‡∏≠‡∏Å
                
                // 5. ‡∏î‡∏∂‡∏á S5 (scripts_s5)
                const { data: s5Data, error: s5Error } = await window.supabase
                    .from('scripts_s5')
                    .select('step_index, step_name, customer_audio_url')
                    .overlaps('product_type', FILTER_TAGS) // <-- FILTERED
                    .order('step_index', { ascending: true });
                if (s5Error) throw s5Error;
                globalS5Steps = s5Data;

                window.loadingText.textContent = `‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Supabase ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!`;
                
                // preloadCriticalAudio(); // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÇ‡∏Ñ‡πâ‡∏î preload ‡∏î‡πâ‡∏ß‡∏¢
                
                setTimeout(() => { window.loadingOverlay.style.display = "none"; }, 500);
                return true; 
                
            } catch (error) {
                console.error("Failed to fetch initial data:", error);
                window.loadingText.textContent = `‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Supabase Tables`;
                window.startTestBtn.disabled = true;
                setTimeout(() => { window.loadingOverlay.style.display = "none"; }, 3000);
                return false;
            }
        };

        // --- Flow (‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏° S4) ---

        const prepareTurnFiles = function() { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î PrepareTurnFiles ‡πÄ‡∏î‡∏¥‡∏° ... */ };
        const endTurn = function() { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î EndTurn ‡πÄ‡∏î‡∏¥‡∏° ... */ };
        const initSection1_5 = function() { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î InitSection1_5 ‡πÄ‡∏î‡∏¥‡∏° ... */ };
        const endPitchRecording = function() { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î EndPitchRecording ‡πÄ‡∏î‡∏¥‡∏° ... */ };
        const initSection2 = function() { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î InitSection2 ‡πÄ‡∏î‡∏¥‡∏° ... */ };
        const playSequentialQuestion = function() { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î PlaySequentialQuestion ‡πÄ‡∏î‡∏¥‡∏° ... */ };
        
        const initSection3 = function() {
            hideAll(); 
            document.getElementById('section3Div').style.display = 'block';
            window.closeBtn.disabled = false; 
            window.replyBtn.disabled = true;
            // ‚ö†Ô∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô nextSection4Btn ‡πÄ‡∏õ‡πá‡∏ô nextSection5Btn
            window.nextSection5Btn.disabled = true; 
            cRound = 0;
            window.closeBtn.style.display = 'block'; 
            lastCustomerAudioUrl = 'S3 Initial Closing (No Customer Audio)'; 
            window.s3StatusElement.textContent = "‚úÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2 ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏î '1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢";
        };

        const playSequentialObjectionAuto = function() {
            if (cRound >= maxC) {
                window.s3StatusElement.textContent = "üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5";
                window.replyBtn.disabled = true;
                window.closeBtn.style.display = 'none'; 
                // ‚ö†Ô∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô nextSection4Btn ‡πÄ‡∏õ‡πá‡∏ô nextSection5Btn
                window.nextSection5Btn.disabled = false; 
                return;
            }
            // ... (‡πÇ‡∏Ñ‡πâ‡∏î PlaySequentialObjectionAuto ‡πÄ‡∏î‡∏¥‡∏°) ...
        };

        const startNextCloseRoundAuto = function() {
            if (cRound < maxC) {
                // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°) ...
            } else {
                window.s3StatusElement.textContent = "üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5";
                window.replyBtn.disabled = true;
                window.closeBtn.style.display = 'none';
                // ‚ö†Ô∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô nextSection4Btn ‡πÄ‡∏õ‡πá‡∏ô nextSection5Btn
                window.nextSection5Btn.disabled = false; 
            }
        };
        
        // ‚ö†Ô∏è ‡∏•‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô S4 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (initSection4, updateHUI, playFixedHealthQuestion, playFollowUp) ‡∏≠‡∏≠‡∏Å

        const initSection5 = function() { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î InitSection5 ‡πÄ‡∏î‡∏¥‡∏° ... */ };
        const playCustomerReplyAndSetupNextStep = function() { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î PlayCustomerReplyAndSetupNextStep ‡πÄ‡∏î‡∏¥‡∏° ... */ };

        // --- Initialization and Event Listeners (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Auto Fill) ---
        const initializeUserAndDOM = async function() {
            // ... (‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î ID ‡πÅ‡∏•‡∏∞ DOM Element ‡πÄ‡∏î‡∏¥‡∏°) ...
            
            // NEW LOGIC: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∑‡πà‡∏≠/‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏à‡∏≤‡∏Å Local Storage (Fix)
            const storedUserData = localStorage.getItem('roleplayUserData');

            if (storedUserData) {
                try {
                    const userData = JSON.parse(storedUserData);
                    window.inputUserName.value = userData.fullName || '';
                    window.inputUserGroup.value = userData.department || '';
                } catch (e) {
                    console.error("Error parsing user data from localStorage:", e);
                }
            }
            
            // ‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å S3 ‡πÑ‡∏õ S5
            document.getElementById('nextSection5Btn').addEventListener('click', initSection5); 

            // ... (‡∏™‡πà‡∏ß‡∏ô Event Listeners ‡πÅ‡∏•‡∏∞ startTest ‡πÄ‡∏î‡∏¥‡∏°) ...
            // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏≤‡∏ß‡∏°‡∏≤‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏ß‡πâ‡πÉ‡∏ô <script>
            
            const dataLoaded = await fetchInitialData();
            if (!dataLoaded) {
                window.startTestBtn.disabled = true;
                window.startTestBtn.textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ";
            }
        }

        document.addEventListener('DOMContentLoaded', initializeUserAndDOM);
        
        // ... (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: init, toggleRecording, prepareTurnFiles, nextTurn, initSection2, etc. ‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà) ...
    </script>
</body>
</html>
