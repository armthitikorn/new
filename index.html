<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Explorer (ID & Date Filter)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h1 { color: #1a73e8; text-align: center; margin-bottom: 30px; }
        
        /* Filter Panel */
        .filter-panel { 
            background: #ffffff; padding: 20px; border-radius: 10px; 
            margin-bottom: 20px; display: flex; align-items: flex-end; gap: 15px; flex-wrap: wrap;
            border: 1px solid #dee2e6; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
        }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: 0.85em; font-weight: bold; color: #555; }
        input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; outline: none; transition: 0.2s; }
        input:focus { border-color: #1a73e8; box-shadow: 0 0 0 2px rgba(26,115,232,0.2); }
        input[type="text"] { min-width: 250px; }
        
        .btn-search { background: #1a73e8; color: white; border: none; padding: 10px 25px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-search:hover { background: #1557b0; transform: translateY(-1px); }

        /* Status & Table */
        .status-box { padding: 12px; margin-bottom: 15px; border-radius: 8px; text-align: center; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        th { background-color: #f8f9fa; color: #5f6368; padding: 15px 12px; text-align: left; border-bottom: 2px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
        tr:hover { background-color: #fcfcfc; }
        
        audio { height: 32px; width: 220px; }
        .date-text { color: #555; font-weight: 500; }
        .badge { padding: 5px 10px; border-radius: 6px; font-family: monospace; font-size: 0.9em; }
        .bg-user { background: #e9ecef; color: #495057; border: 1px solid #dee2e6; }
        .bg-part { background: #e7f3ff; color: #007bff; font-weight: bold; }
        .download-link { color: #1a73e8; text-decoration: none; font-weight: 600; }
        .download-link:hover { text-decoration: underline; }
    </style>
</head>
<body>

<div class="container">
    <h1>üìÇ Audio Storage Explorer</h1>

    <div class="filter-panel">
        <div class="filter-group">
            <label>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢ User ID:</label>
            <input type="text" id="searchId" placeholder="‡∏ß‡∏≤‡∏á ID ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á ID)">
        </div>
        <div class="filter-group">
            <label>üìÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
            <input type="date" id="startDate">
        </div>
        <div class="filter-group">
            <label>üìÖ ‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
            <input type="date" id="endDate">
        </div>
        <button class="btn-search" onclick="scanStorage()">‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
    
    <div id="status" class="status-box" style="background: #e8f0fe; color: #1967d2;">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"</div>

    <table id="fileTable">
        <thead>
            <tr>
                <th width="180">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</th>
                <th width="250">User ID</th>
                <th width="100">Section</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á</th>
                <th>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á</th>
                <th width="100">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
        </thead>
        <tbody id="fileList">
            <tr><td colspan="6" style="text-align:center; padding: 50px; color: #999;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</td></tr>
        </tbody>
    </table>
</div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase [‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå index (5).html]
    const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
    const supabase = createClient(supabaseUrl, supabaseKey);

    async function scanStorage() {
        const statusEl = document.getElementById('status');
        const listEl = document.getElementById('fileList');
        
        // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
        const searchId = document.getElementById('searchId').value.trim().toLowerCase();
        const startVal = document.getElementById('startDate').value;
        const endVal = document.getElementById('endDate').value;
        
        statusEl.style.background = '#fff3cd';
        statusEl.style.color = '#856404';
        statusEl.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç...';
        listEl.innerHTML = '';

        try {
            // 1. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ User Folders ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            const { data: users, error: userError } = await supabase.storage.from('responses').list('');
            if (userError) throw userError;

            let matchCount = 0;

            for (const user of users) {
                if (user.name === '.emptyFolderPlaceholder') continue;

                // --- ‡∏Å‡∏£‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢ User ID ---
                if (searchId && !user.name.toLowerCase().includes(searchId)) {
                    continue; // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏° User ‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
                }

                // 2. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Section Folders (S1, S2...)
                const { data: sections, error: sectionError } = await supabase.storage.from('responses').list(user.name);
                if (sectionError) continue;

                for (const section of sections) {
                    const path = `${user.name}/${section.name}`;
                    const { data: files, error: fileError } = await supabase.storage.from('responses').list(path);
                    if (fileError) continue;

                    for (const file of files) {
                        if (file.name.endsWith('.webm')) {
                            
                            // --- ‡∏Å‡∏£‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ---
                            const fileDate = new Date(file.created_at);
                            const fileDateOnly = fileDate.toISOString().split('T')[0];

                            let isDateMatch = true;
                            if (startVal && fileDateOnly < startVal) isDateMatch = false;
                            if (endVal && fileDateOnly > endVal) isDateMatch = false;

                            if (isDateMatch) {
                                matchCount++;
                                const { data: { publicUrl } } = supabase.storage.from('responses').getPublicUrl(`${path}/${file.name}`);
                                
                                const displayDate = fileDate.toLocaleString('th-TH', { 
                                    year: 'numeric', month: 'short', day: 'numeric', 
                                    hour: '2-digit', minute: '2-digit' 
                                });

                                appendRow(displayDate, user.name, section.name, file.name, publicUrl);
                            }
                        }
                    }
                }
            }

            statusEl.style.background = '#d4edda';
            statusEl.style.color = '#155724';
            statusEl.textContent = `‚úÖ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ${matchCount} ‡πÑ‡∏ü‡∏•‡πå`;
            
            if(matchCount === 0) {
                listEl.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö User ID ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏</td></tr>';
            }

        } catch (err) {
            statusEl.style.background = '#f8d7da';
            statusEl.style.color = '#721c24';
            statusEl.textContent = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message;
        }
    }

    function appendRow(dateStr, userId, section, fileName, url) {
        const listEl = document.getElementById('fileList');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="date-text">${dateStr}</td>
            <td><span class="badge bg-user">${userId}</span></td>
            <td><span class="badge bg-part">${section}</span></td>
            <td style="font-size: 0.8em; color: #888;">${fileName}</td>
            <td><audio controls src="${url}"></audio></td>
            <td><a href="${url}" target="_blank" class="download-link">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</a></td>
        `;
        listEl.appendChild(row);
    }

    window.scanStorage = scanStorage;
</script>

</body>
</html>
