<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Data Migration Tool - Recovery Jan 9</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-dark text-white p-5">
    <div class="container bg-white text-dark p-4 rounded-4 shadow">
        <h2 class="fw-bold mb-4 text-primary">‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Storage -> Database)</h2>
        <p>‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏™‡πÅ‡∏Å‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô Storage ‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á <b>submissions</b> ‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
        
        <button id="startBtn" class="btn btn-danger btn-lg w-100 fw-bold shadow-sm mb-4">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Start Migration)</button>
        
        <div id="log" class="border p-3 rounded bg-light font-monospace" style="height: 400px; overflow-y: auto; font-size: 12px;">
            ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô... ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno';
        const supabase = createClient(supabaseUrl, supabaseKey);

        const log = document.getElementById('log');
        const printLog = (msg) => { log.innerHTML += `<div>${msg}</div>`; log.scrollTop = log.scrollHeight; };

        document.getElementById('startBtn').onclick = async () => {
            printLog("üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô Storage...");
            
            // 1. ‡∏î‡∏∂‡∏á ID ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Storage
            const { data: folders, error } = await supabase.storage.from('responses').list('');
            if (error) return printLog(`‚ùå Error: ${error.message}`);

            for (const folder of folders) {
                if (folder.name === '.emptyFolderPlaceholder') continue;
                
                const empId = folder.name;
                printLog(`-----------------------------------`);
                printLog(`üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ID: ${empId}`);

                const steps = ['S1', 'S1.5', 'S2', 'S3', 'S4', 'S5'];
                let updatePayload = {};
                let foundAny = false;

                // 2. ‡∏°‡∏∏‡∏î‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞ Step
                for (const step of steps) {
                    const { data: files } = await supabase.storage.from('responses').list(`${empId}/${step}`);
                    
                    if (files && files.length > 0) {
                        const audioFile = files.find(f => !f.name.includes('.empty'));
                        if (audioFile) {
                            // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                            const publicUrl = `${supabaseUrl}/storage/v1/object/public/responses/${empId}/${step}/${audioFile.name}`;
                            
                            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Update (‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö SQL ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤ Run ‡πÑ‡∏õ)
                            const colName = step.replace('.', '_').toLowerCase() + '_audio_url';
                            updatePayload[`${colName}`] = publicUrl;
                            foundAny = true;
                            printLog(`‚úÖ ‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô ${step}: ${audioFile.name}`);
                        }
                    }
                }

                if (foundAny) {
                    // 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
                    const { data: existing } = await supabase.from('submissions').select('id').eq('user_id', empId).single();

                    if (existing) {
                        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ Update
                        const { error: upError } = await supabase.from('submissions').update(updatePayload).eq('user_id', empId);
                        if (!upError) printLog(`üíæ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                    } else {
                        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏Ñ‡∏™‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 9 ‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡πà‡∏≤‡∏á) ‡πÉ‡∏´‡πâ Insert ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏•‡∏¢
                        const { error: inError } = await supabase.from('submissions').insert({
                            user_id: empId,
                            name: `‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô (${empId.substring(0,5)})`,
                            created_at: folder.created_at,
                            ...updatePayload
                        });
                        if (!inError) printLog(`‚ú® ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)!`);
                    }
                } else {
                    printLog(`‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏¢‡πà‡∏≠‡∏¢‡πÉ‡∏î‡πÜ`);
                }
            }
            printLog(`-----------------------------------`);
            printLog(`üèÅ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!`);
            alert("‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ Dashboard");
        };
    </script>
</body>
</html>
