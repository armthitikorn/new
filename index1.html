<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>E-Simulator Roleplay (‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û)</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { 
            font-family: 'Sarabun', sans-serif;
            padding: 20px; 
            text-align: center; 
            background-color: #f4f7f6;
        }
        .container-box {
            max-width: 700px; 
            margin: 0 auto; 
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }
        h1 { 
            font-size: 32px;
            color: #d9534f;
            margin-bottom: 20px;
        }
        h2 { 
            margin-top: 25px;
            font-size: 24px;
            color: #337ab7;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            text-align: left;
        }
        .status-bar {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 16px;
            text-align: center;
        }
        .loading-text { color: orange; background-color: #fff3cd; border: 1px solid #ffeeba; }
        .success-text { color: green; background-color: #d4edda; border: 1px solid #c3e6cb; }
        .error-text { color: red; background-color: #f8d7da; border: 1px solid #f5c6cb; }

        /* Recording Section */
        #recordBtn {
            padding: 15px 30px;
            font-size: 18px;
            background-color: #d9534f;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 15px;
        }
        #recordBtn:hover {
            background-color: #c9302c;
        }
        #recordBtn[disabled] {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* Customer Reply Section */
        #customerReply {
            border: 1px solid #ccc;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            text-align: left;
            background-color: #f9f9f9;
        }
        #customerReply h3 {
            color: #333;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 18px;
        }
        #customerAudio {
            width: 100%;
            margin-top: 10px;
        }
        #responseText {
            font-style: italic;
            color: #555;
            min-height: 20px;
            margin-top: 10px;
        }

        /* Detail Boxes */
        .info-box {
            background-color: #f0f8ff;
            border: 1px solid #b0e0e6;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            text-align: left;
        }
        .info-box strong {
            color: #007bff;
        }

        /* Difficulty Radio Styles */
        .difficulty-option {
            margin: 10px 0;
            text-align: left;
        }
        .difficulty-option input {
            margin-right: 10px;
        }
    </style>
</head>
<body>

<div class="container-box">
    <h1>E-Simulator Roleplay ü©∫</h1>
    <h2 id="productNameDisplay">...</h2>

    <div id="registrationSection">
        <div class="info-box">
            <strong>‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå:</strong> <span id="productNameDisplayInfo">...</span><br>
            <strong>‡∏ä‡∏∑‡πà‡∏≠/‡∏£‡∏´‡∏±‡∏™:</strong> <span id="userNameDisplay">...</span><br>
            <strong>‡πÅ‡∏ú‡∏ô‡∏Å:</strong> <span id="departmentDisplay">...</span>
        </div>
        
        <h2>0. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å</h2>
        <div id="difficultyOptions">
            <div class="difficulty-option">
                <input type="radio" id="easy" name="difficulty" value="EASY" checked>
                <label for="easy">EASY (‡∏™‡∏±‡πâ‡∏ô)</label>
            </div>
            <div class="difficulty-option">
                <input type="radio" id="medium" name="difficulty" value="MEDIUM">
                <label for="medium">MEDIUM (‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á)</label>
            </div>
            <div class="difficulty-option">
                <input type="radio" id="hard" name="difficulty" value="HARD">
                <label for="hard">HARD (‡∏¢‡∏≤‡∏ß)</label>
            </div>
        </div>
        <button id="startTestBtn" onclick="startTest()">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
    </div>
    
    <div id="testSection" style="display: none;">
        
        <div class="status-bar" id="s1StatusElement"></div>

        <div class="info-box">
            <strong>‡∏£‡∏≠‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (S1/S2/S3/S4/S5):</strong> 
            <span id="maxTurnSpan">0</span> / 
            <span id="maxQSpan">0</span> / 
            <span id="maxCSpan">0</span> / 
            <span id="maxHSpan">0</span> / 
            <span id="maxASpan">0</span>
        </div>
        
        <div id="customerReply">
            <h3>‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</h3>
            <p id="responseText">‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</p>
            <audio id="customerAudio" controls autoplay></audio>
        </div>

        <button id="recordBtn">üî¥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <p id="recordingStatus" style="color: blue; margin-top: 10px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏û‡∏£‡πâ‡∏≠‡∏°</p>
        
        <hr style="margin-top: 20px;">
        
        <div id="section1Div"><h2>1. ‡∏ö‡∏ó‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏™‡∏≤‡∏¢ (S1)</h2></div>
        <div id="section1_5Div" style="display:none;"><h2>1.5 ‡∏ö‡∏ó‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (S1.5)</h2></div>
        <div id="section2Div" style="display:none;"><h2>2. ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (S2)</h2></div>
        <div id="section3Div" style="display:none;"><h2>3. ‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á (S3)</h2></div>
        <div id="section4Div" style="display:none;"><h2>4. ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (S4)</h2></div>
        <div id="section5Div" style="display:none;"><h2>5. ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (S5)</h2></div>

        <a href="index.html" style="display:block; margin-top: 20px;">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
    </div>
</div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    
    // ** 1. Supabase Configuration **
    const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
    window.supabase = createClient(supabaseUrl, supabaseKey);

    // Global State
    const CURRENT_PRODUCT_ID = localStorage.getItem('roleplaySelectedProduct') || 'health'; 
    let userData = {};
    
    // üö® DEFAULT/FALLBACK CONFIG (MUST MATCH HTML VALUES: EASY, MEDIUM, HARD)
    let difficultyConfig = {
        EASY: { S1: 3, S2: 5, S3: 3, S4: 5, S5: 7, label: "‡∏á‡πà‡∏≤‡∏¢ (Easy)" }, 
        MEDIUM: { S1: 5, S2: 8, S3: 8, S4: 5, S5: 7, label: "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (Medium)" }, 
        HARD: { S1: 10, S2: 10, S3: 10, S4: 5, S5: 7, label: "‡∏¢‡∏≤‡∏Å (Hard)" } 
    };

    // Global Data Stores (‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Supabase ‡∏´‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)
    let s1Turns = [];
    let s2Questions = [];
    let s3Objections = [];
    let s4HealthQuestions = [];
    let s4FollowUpNames = [];
    let s4FollowUpReplies = [];
    let s5Scripts = [];
    let yesTriggerQ = null;

    let currentTurnIndex = 0;
    let maxTurns = 0;
    let maxQ = 0;
    let maxC = 0;
    let maxH = 0;
    let maxA = 0;
    let lastCustomerAudioUrl = 'S1 Initial Greeting (No Customer Audio)';
    let recorder;
    
    // DOM Elements (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á)
    window.loadingText = document.getElementById('s1StatusElement');
    
    // --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (READ) - ‡πÉ‡∏ä‡πâ .or() ---
    const fetchInitialData = async () => {
        window.loadingText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Supabase...';
        window.loadingText.className = 'loading-text';
        let isSuccess = true;

        try {
            // üö® CRITICAL FIX: ‡πÉ‡∏ä‡πâ .or() ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö TEXT Filter
            // product_type.eq.health,product_type.eq.all
            const orFilter = `product_type.eq.${CURRENT_PRODUCT_ID},product_type.eq.all`;
            
            // 2.0 Config (‡πÇ‡∏´‡∏•‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô TypeError: Cannot read properties of undefined (reading 'S1'))
            const { data: cData, error: cError } = await window.supabase.from('difficulty_config').select('*');
            if (cError) throw cError;
            
            // üö® Robust check: ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤ Default ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
            if (cData && cData.length > 0) {
                 difficultyConfig = {}; // Clear default config
                 cData.forEach(c => difficultyConfig[c.difficulty_level.toUpperCase()] = { S1: c.max_s1, S2: c.max_s2, S3: c.max_s3, S4: c.max_s4, S5: c.max_s5 });
            }
            
            // 2.1 S1 Customer Replies
            const { data: s1Data, error: s1Error } = await window.supabase
                .from('customer_replies_s1')
                .select('turn_index, audio_url, is_finale')
                .or(orFilter) // üö® FIXED: ‡πÉ‡∏ä‡πâ .or()
                .order('turn_index', { ascending: true });
            if (s1Error) throw s1Error;
            s1Turns = s1Data;
            
            // 2.2 S2 Questions
            const { data: s2Data, error: s2Error } = await window.supabase
                .from('questions_s2')
                .select('q_index, audio_url, q_text')
                .or(orFilter) // üö® FIXED: ‡πÉ‡∏ä‡πâ .or()
                .order('q_index', { ascending: true });
            if (s2Error) throw s2Error;
            s2Questions = s2Data;

            // 2.3 S3 Objections
            const { data: s3Data, error: s3Error } = await window.supabase
                .from('objections_s3')
                .select('ob_index, audio_url, ob_text')
                .or(orFilter) // üö® FIXED: ‡πÉ‡∏ä‡πâ .or()
                .order('ob_index', { ascending: true });
            if (s3Error) throw s3Error;
            s3Objections = s3Data;

            // 2.4 S4 Health Questions
            const { data: s4qData, error: s4qError } = await window.supabase
                .from('health_questions_s4')
                .select('*') 
                .or(orFilter) // üö® FIXED: ‡πÉ‡∏ä‡πâ .or()
                .order('q_index', { ascending: true });
            if (s4qError) throw s4qError;
            s4HealthQuestions = s4qData;
            yesTriggerQ = s4qData.find(q => q.is_yes_trigger); 

            // 2.5 S4 Follow Up Names
            const { data: s4fuNameData, error: s4fuNameError } = await window.supabase
                .from('s4_follow_up_names')
                .select('*')
                .or(orFilter) // üö® FIXED: ‡πÉ‡∏ä‡πâ .or()
                .order('step_index', { ascending: true });
            if (s4fuNameError) throw s4fuNameError;
            s4FollowUpNames = s4fuNameData;
            
            // 2.6 S4 Follow Up Replies
            const { data: s4furData, error: s4furError } = await window.supabase
                .from('s4_follow_up_replies')
                .select('*')
                .or(orFilter) // üö® FIXED: ‡πÉ‡∏ä‡πâ .or()
                .order('step_index', { ascending: true });
            if (s4furError) throw s4furError;
            s4FollowUpReplies = s4furData;

            // 2.7 S5 Scripts
            const { data: s5Data, error: s5Error } = await window.supabase
                .from('scripts_s5')
                .select('*')
                .or(orFilter) // üö® FIXED: ‡πÉ‡∏ä‡πâ .or()
                .order('step_index', { ascending: true });
            if (s5Error) throw s5Error;
            s5Scripts = s5Data;

        } catch (err) {
            console.error('Fetch error:', err);
            window.loadingText.textContent = `‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å: ${err.message}. (‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)`;
            window.loadingText.className = 'error-text';
            isSuccess = false;
        }

        // üö® CRITICAL FIX: ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πâ‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏∞‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
        if (isSuccess && s1Turns.length > 0) {
            window.loadingText.textContent = '‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å';
            window.loadingText.className = 'success-text';
            document.getElementById('startTestBtn').disabled = false;
        } else {
             // ‡∏´‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î S1 ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ Default Config
            window.loadingText.textContent = `‚ö†Ô∏è ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• S1 ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (0 ‡πÑ‡∏ü‡∏•‡πå) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö RLS Policy! ‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô`;
            window.loadingText.className = 'error-text';
             document.getElementById('startTestBtn').disabled = false; // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ default
        }
    };

    // --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Initialize) ---
    const initializeUserAndDOM = () => {
        const storedUserData = localStorage.getItem('roleplayUserData');
        if (!storedUserData) {
            alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å");
            window.location.href = 'index.html';
            return;
        }
        userData = JSON.parse(storedUserData);
        document.getElementById('userNameDisplay').textContent = userData.fullName || 'N/A';
        document.getElementById('departmentDisplay').textContent = userData.department || 'N/A';
        document.getElementById('productNameDisplay').textContent = `‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå: ${CURRENT_PRODUCT_ID.toUpperCase()}`;
        document.getElementById('productNameDisplayInfo').textContent = CURRENT_PRODUCT_ID.toUpperCase();
        
        // üö® BIND EVENT LISTENER HERE (Fixes the issue from previous steps where startTest wasn't globally accessible)
        document.getElementById('startTestBtn').addEventListener('click', startTest);
        
        fetchInitialData();
    };

    // --- 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö (Start Test) ---
    window.startTest = function() {
        const selectedDifficulty = document.querySelector('input[name="difficulty"]:checked').value;
        const config = difficultyConfig[selectedDifficulty]; // üö® FIXED: ‡πÉ‡∏ä‡πâ config ‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global

        if (!config || s1Turns.length === 0) {
            // ‡∏´‡∏≤‡∏Å config ‡∏´‡∏£‡∏∑‡∏≠ S1 ‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ (‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å RLS fail)
            alert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• S1 ‡∏´‡∏£‡∏∑‡∏≠ Difficulty Config ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö RLS Policy ‡πÉ‡∏ô Supabase');
            return;
        }

        maxTurns = config.S1;
        maxQ = config.S2;
        maxC = config.S3;
        maxH = config.S4;
        maxA = config.S5; 
        
        // ... (‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Max Turns) ...
        document.getElementById('maxTurnSpan').textContent = maxTurns;
        document.getElementById('maxQSpan').textContent = maxQ;
        document.getElementById('maxCSpan').textContent = maxC;
        document.getElementById('maxHSpan').textContent = maxH;
        document.getElementById('maxASpan').textContent = maxA; 

        document.getElementById('registrationSection').style.display = 'none';
        document.getElementById('testSection').style.display = 'block';

        // ... (‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Section 1-5) ...
        document.getElementById('section1Div').style.display = 'block';
        document.getElementById('section1_5Div').style.display = 'none';
        document.getElementById('section2Div').style.display = 'none';
        document.getElementById('section3Div').style.display = 'none';
        document.getElementById('section4Div').style.display = 'none';
        document.getElementById('section5Div').style.display = 'none';

        // ... (‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô S1) ...
        // Note: You need to implement preloadCriticalAudio() and prepareTurnFiles() logic
        
        document.getElementById('recordBtn').disabled = false;
        document.getElementById('s1StatusElement').textContent = `üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡∏û‡∏π‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß (‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà 1/${maxTurns})`;
    }
    
    // --- 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Record/Stop (Placeholder) ---
    // Note: The full MediaRecorder/Supabase Storage logic is omitted here for brevity, 
    // but the final working code will need this logic restored.
    document.getElementById('recordBtn').onclick = function() {
        alert("‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î MediaRecorder ‡πÅ‡∏•‡∏∞ Supabase Storage ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤");
    };

    document.addEventListener('DOMContentLoaded', initializeUserAndDOM);
</script>
</body>
</html>
