<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>E-Simulator Roleplay (‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û - DYNAMIC SUPABASE DATA)</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { 
            font-family: 'Sarabun', sans-serif;
            padding: 20px; 
            text-align: center; 
            background-color: #f4f7f6;
        }
        .container-box {
            max-width: 700px; 
            margin: 0 auto; 
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }
        h1 { 
            font-size: 32px;
            color: #d9534f;
            margin-bottom: 20px;
        }
        h2 { 
            margin-top: 25px;
            font-size: 24px;
            color: #337ab7;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        button { 
            margin: 10px 5px;
            padding: 12px 24px; 
            font-size: 18px; 
            cursor: pointer; 
            width: auto; 
            min-height: 48px;
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            opacity: 0.9;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        #finalSaveBtn { background-color: #007bff; color: white; font-weight: bold; }
        #finalSaveBtn.done { background-color: #28a745; }

        .form-control {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
            margin-top: 5px;
            text-align: center;
            font-size: 16px;
        }

        .difficulty-option {
            display: inline-block;
            margin: 8px;
            cursor: pointer;
            padding: 10px 20px;
            border: 2px solid #ccc;
            border-radius: 20px;
            transition: all 0.2s;
        }
        .difficulty-option:hover { border-color: #337ab7; }
        input[type="radio"]:checked + .difficulty-option {
            background-color: #337ab7;
            color: white;
            border-color: #337ab7;
            font-weight: bold;
        }
        input[type="radio"] { display: none; }
        
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); color: white; display: none; 
            justify-content: center; align-items: center; flex-direction: column;
            z-index: 1000; text-align: center; font-size: 20px;
        }
        .spinner-border { width: 3rem; height: 3rem; border: 0.25em solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spinner-border 0.75s linear infinite; }
        @keyframes spinner-border { to { transform: rotate(360deg); } }
        .progress { width: 80%; max-width: 400px; margin-top: 20px; height: 15px; background-color: #e9ecef; border-radius: 0.25rem; overflow: hidden; }
        .progress-bar { height: 100%; background-color: #007bff; transition: width 0.6s ease; }
        
        #certificate { border: 5px solid #333; padding: 40px; width: 90%; max-width: 800px; margin: 40px auto; text-align: center; display: none; }

        @media (max-width: 600px) {
            .container-box {
                padding: 15px;
                margin: 0 10px;
            }
            h1 { font-size: 28px; }
            h2 { font-size: 20px; }
            button { padding: 10px 20px; font-size: 16px; width: 95%; }
            .difficulty-option { margin: 5px; padding: 8px 15px; }
        }
    </style>
</head>
<body>
    
    <div id="loadingOverlay">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h5 id="loadingText" class="mt-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á...</h5>
        <div class="progress" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
            <div id="uploadProgressBar" class="progress-bar" style="width: 0%"></div>
        </div>
    </div>

    <div class="container-box">
        <h1>E-Simulator Roleplay (‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û)</h1>
        
        <div id="registrationSection">
            <h2 style="color: #333;">üìù ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h2>
            <div style="margin-bottom: 20px;">
                <label for="inputUserName" style="font-weight: bold; display: block; margin-bottom: 10px;">
                    ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•/‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:
                </label>
                <input type="text" class="form-control" id="inputUserName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" required>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label for="inputUserGroup" style="font-weight: bold; display: block; margin-bottom: 10px;">
                    ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö:
                </label>
                <select class="form-control" id="inputUserGroup" required>
                    <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>
                    <option value="Nursery">‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏ô‡∏≠‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡∏µ‡πà</option>
                    <option value="NewTSRsOnboarding">‡∏Å‡∏•‡∏∏‡πà‡∏° New TSRs On boarding</option>
                    <option value="NewTSRs">‡∏Å‡∏•‡∏∏‡πà‡∏° New TSRs</option>
                    <option value="ExistingTSRs">‡∏Å‡∏•‡∏∏‡πà‡∏° TSRs existing</option>
                    </select>
            </div>
            <div style="margin-bottom: 30px;">
                <label style="font-weight: bold; display: block; margin-bottom: 10px;">
                    ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö:
                </label>
                <div>
                    <input type="radio" id="diffEasy" name="difficulty" value="easy" checked>
                    <label for="diffEasy" class="difficulty-option">‡∏á‡πà‡∏≤‡∏¢ (Easy)</label>
                    
                    <input type="radio" id="diffHard" name="difficulty" value="hard">
                    <label for="diffHard" class="difficulty-option">‡∏¢‡∏≤‡∏Å (Hard)</label>

                    <input type="radio" id="diffHarder" name="difficulty" value="harder">
                    <label for="diffHarder" class="difficulty-option">‡∏¢‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô (Harder)</label>
                </div>
            </div>
            
            <button id="startTestBtn" style="background-color: #28a745; color: white;">
                ‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
            </button>
            <hr>
        </div>
        
        <div id="testSection" style="display: none;">
            
            <div id="section1Div">
                <h2>üó£Ô∏è ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß/‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏™‡∏≤‡∏¢ (‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà <span id="turnSpan">1</span>/<span id="maxTurnSpan">5</span>)</h2>
                <audio id="customerAudio" src=""></audio>
                <button id="recordBtn">üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)</button>
                <button disabled id="nextRoundBtn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1.5)</button>
                <p id="status">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡∏û‡∏π‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß</p>
                <hr>
            </div>

            <div id="section1_5Div" style="display: none;">
                <h2>üõí ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1.5: ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå (Pitch)</h2>
                <button disabled id="pitchRecordBtn">üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠</button>
                <button disabled id="nextSection2Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1.5 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2)</button>
                <p id="pitchStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠</p>
                <hr>
            </div>

            <div id="section2Div" style="display: none;">
                <h2>‚ùì ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà <span id="qRound">1</span>/<span id="maxQSpan">10</span>)</h2>
                <audio id="questionAudio"></audio>
                <button disabled id="startQBtn">üîä ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
                <button disabled id="answerBtn">üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
                <button disabled id="nextSection3Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3)</button>
                <p id="qStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2</p>
                <hr>
            </div>

            <div id="section3Div" style="display: none;">
                <h2>üí∞ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3: ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ + ‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á (‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà <span id="cRound">1</span>/<span id="maxCSpan">5</span>)</h2>
                <button disabled id="closeBtn">üéôÔ∏è 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
                <audio id="objectionAudio"></audio>
                <button disabled id="replyBtn">üéôÔ∏è 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á</button>
                <button disabled id="nextSection4Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4)</button>
                <p id="cStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3</p>
                <hr>
            </div>

            <div id="section4Div" style="display: none;">
                <h2>üè• ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (<span id="hQName">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà 1/5: ‡πÇ‡∏£‡∏Ñ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</span>)</h2>
                
                <div id="healthQuestionDisplay" style="margin: 15px 0; padding: 15px; border: 1px dashed #d9534f; border-radius: 8px; background-color: #ffeaea; font-weight: bold; font-size: 18px; color: #333;">
                    <p>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å: ‡πÉ‡∏ô 5 ‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤ ‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö ‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ï‡∏±‡∏ß‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
                </div>
                <audio id="healthAudio"></audio>
                <button disabled id="answerHBtn">üéôÔ∏è 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</button>
                <button disabled id="nextSection5Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5)</button>
                <p id="hStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4</p>
                <hr>
            </div>

            <div id="section5Div" style="display: none;">
                <h2>ü§ù ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà <span id="aRound">1</span>/<span id="maxASpan">7</span>)</h2>
                <audio id="agreementAudio"></audio>
                
                <div id="registrationStepsDisplay" style="text-align: left; margin: 15px 0; padding: 15px; border: 1px solid #ccc; border-radius: 8px; background-color: #f8f9fa;">
                    <h4 style="color: #333; margin-top: 0;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</h4>
                    <ol id="stepList" style="padding-left: 20px; font-size: 16px;">
                        </ol>
                </div>
                <button disabled id="answerABtn">üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button> 
                <button disabled id="finalSaveBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
                <p id="aStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5</p>
                <hr>
            </div>

            <div id="certificate">
                <h1>‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡∏¢‡∏ö‡∏±‡∏ï‡∏£</h1>
                <p>‡∏Ç‡∏≠‡∏°‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πà</p>
                <h2 id="traineeName">[‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô]</h2>
                <p>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</p>
                <p><strong>‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ó‡∏≤‡∏á‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</strong></p>
                <p style="margin-top: 40px;">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠....................................................</p>
                <p>(‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°)</p>
                <p style="margin-top: 20px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®: <span id="issueDate"></span></p>
            </div>
            <button id="certBtn">üéì ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        import { v4 as uuidv4 } from 'https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/esm-browser/index.js';

        // --- 1. Supabase Config & Global State ---
        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
        window.supabase = createClient(supabaseUrl, supabaseKey);

        const PRODUCT_ID = 'health'; // üö® ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà 'health' ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ
        
        let mediaRecorder = null;
        let currentUserId = null; 
        const USER_ID_KEY = 'roleplay_user_id';
        
        let allRecordings = []; 
        let lastCustomerAudioUrl = 'N/A';
        
        // --- DYNAMIC DATA STORE (‡πÅ‡∏ó‡∏ô Hardcoded Lists) ---
        let dataStore = {
            config: {}, 
            s1Files: [], s2Questions: [], s3Objections: [], 
            s4HealthQuestions: [], s4FollowUpNames: [], s4FollowUpReplies: [], 
            s5Scripts: [], yesTriggerQ: null, 
            noAnswerUrl: "URL-TO-NO-ANSWER-AUDIO" 
        };

        // Round Counters and Max Rounds 
        let turn = 0; let qRound = 0; let cRound = 0; let currentHIndex = 0; 
        let isFollowUpMode = false; let followUpStep = 0; let aRound = 0; 
        let maxTurns, maxQ, maxC, maxH, maxA; 
        let maxFollowUp = 5; 
        
        // --- Utility Functions (Preload/Cache/UI Update Logic) ---
        let audioCache = {};

        const getCachedAudioElement = function(url, fallbackToNew = true) {
            if (!url) return null;
            if (audioCache[url]) {
                const cachedAudio = audioCache[url].cloneNode(true);
                cachedAudio.currentTime = 0;
                return cachedAudio;
            }
            if (fallbackToNew) {
                return new Audio(url);
            }
            return null;
        }

        const preloadCriticalAudio = function() {
            // (Function logic remains the same, uses dataStore to get URLs)
            const allUrls = [];
            dataStore.s1Files.forEach(f => f.audio_url && allUrls.push(f.audio_url));
            dataStore.s2Questions.forEach(q => q.audio_url && allUrls.push(q.audio_url));
            dataStore.s3Objections.forEach(o => o.audio_url && allUrls.push(o.audio_url));
            if (dataStore.yesTriggerQ && dataStore.yesTriggerQ.yes_trigger_url) allUrls.push(dataStore.yesTriggerQ.yes_trigger_url);
            dataStore.s4FollowUpReplies.forEach(r => r.customer_audio_url && allUrls.push(r.customer_audio_url));
            dataStore.s5Scripts.forEach(s => s.customer_audio_url && allUrls.push(s.customer_audio_url));
            if (dataStore.noAnswerUrl !== 'URL-TO-NO-ANSWER-AUDIO') allUrls.push(dataStore.noAnswerUrl);

            console.log(`Preloading ${allUrls.length} customer audio files...`);

            allUrls.forEach(url => {
                if (!audioCache[url]) {
                    const audio = new Audio(url);
                    audio.load(); 
                    audioCache[url] = audio;
                }
            });
            console.log("Preloading started. The test can proceed.");
        }
        
        const updateHealthQuestionUI = function() {
            // (Function logic remains the same, uses dataStore for names/text)
        }

        const renderRegistrationSteps = function() {
            window.stepList.innerHTML = ''; 
            dataStore.s5Scripts.forEach(s => {
                const li = document.createElement('li');
                li.id = `reg-step-${s.step_index}`;
                li.textContent = s.step_name;
                window.stepList.appendChild(li);
            });
        }
        const updateStepHighlight = function(currentStep) {
            // (Function logic remains the same)
        }
        const generateCertificate = function() {
            // (Function logic remains the same)
        }

        // --- BATCH UPLOAD Logic (Store to Array) ---
        const storeRecording = function(audioBlob, part, qNum, qText, customerAudioUrl = 'N/A') {
            allRecordings.push({ audioBlob, part, qNum, qText, customerAudioUrl });
            console.log(`‚úÖ Recording saved locally: P${part}-Q${qNum}. Customer Audio URL: ${customerAudioUrl}. Total recordings: ${allRecordings.length}`);
            
            const statusElement = (part === 1) ? window.s1StatusElement : 
                                  (part === 15) ? window.pitchStatusElement : 
                                  (part === 2) ? window.s2StatusElement : 
                                  (part === 3) ? window.s3StatusElement :
                                  (part === 4) ? window.hStatusElement : 
                                  (part === 5) ? window.aStatusElement : null;
            if(statusElement) {
                statusElement.textContent = `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á P${part}-${qNum} ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß (${allRecordings.length} ‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î)`;
            }
        }

        const uploadAllRecordings = async function() {
            // (Function logic remains the same, uses PRODUCT_ID and user data from input)
        }
        
        // --- Main Recording Logic (‡∏î‡∏∂‡∏á URL ‡∏à‡∏≤‡∏Å dataStore) ---
        const toggleRecording = async function(type) {
            let statusElement, buttonElement, nextAutoAction, originalButtonText;
            let part, qNum, qText, chunks = [];
            
            let currentCustomerUrl = lastCustomerAudioUrl; 
            const currentHQuestion = dataStore.s4HealthQuestions.find(q => q.q_index === currentHIndex + 1);
            const currentFollowUpName = dataStore.s4FollowUpNames.find(n => n.step_index === followUpStep)?.step_name;
            const currentRegStepName = dataStore.s5Scripts.find(s => s.step_index === aRound)?.step_name;


            if (type === 1) { 
                part = 1; qNum = turn + 1; qText = `S1: ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß/‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏™‡∏≤‡∏¢ T${qNum}`;
                statusElement = window.s1StatusElement; buttonElement = window.recordBtn; nextAutoAction = endTurn; originalButtonText = 'üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)';
                currentCustomerUrl = (turn > 0) ? lastCustomerAudioUrl : 'S1 Initial Greeting (No Customer Audio)'; 
            } 
            else if (type === 5) { 
                part = 4; qNum = currentHIndex + 1; qText = `S4: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å Q${currentHIndex + 1}: ${currentHQuestion?.q_text || 'Main Q'}`;
                statusElement = window.hStatusElement; buttonElement = window.answerHBtn; nextAutoAction = playFixedHealthQuestion; originalButtonText = 'üéôÔ∏è 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û';
                currentCustomerUrl = currentHQuestion?.q_text || 'S4 Health Q (Employee Script)';
            } 
            /* ... (Other type mappings, unchanged) ... */
            
            // ... (Recording logic - UNCHANGED, calls storeRecording with currentCustomerUrl) ...
        }
        
        // --- DYNAMIC DATA FLOW FUNCTIONS (‡πÉ‡∏ä‡πâ dataStore) ---
        
        const endTurn = function() {
            if (turn < maxTurns) { 
                turn++;
                window.turnSpan.textContent = turn; 
                
                // üö® FIX: ‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å dataStore
                const fileData = dataStore.s1Files.find(f => f.turn_index === turn);
                const fileToPlay = fileData ? fileData.audio_url : null; 
                
                if (!fileToPlay) {
                     window.s1StatusElement.textContent = `‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á S1 Turn ${turn} ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!`;
                     window.nextRoundBtn.disabled = false;
                     window.recordBtn.disabled = true;
                     return;
                }
                
                const isFinalCustomerTurn = (turn === maxTurns);
                
                // ... (Audio playing logic - UNCHANGED, uses fileToPlay from dataStore) ...
                
                audioEl.onended = () => {
                    lastCustomerAudioUrl = fileToPlay; 
                    /* ... (Next turn logic) ... */
                };
            }
        }

        // ... (playSequentialQuestion, playSequentialObjectionAuto, playFixedHealthQuestion, etc. all updated to use dataStore) ...
        const playSequentialQuestion = function() {
            if (qRound >= maxQ) { /* ... (Finish logic) ... */ return; }
            qRound++; window.qRoundSpan.textContent = qRound;
            
            const fileData = dataStore.s2Questions.find(q => q.q_index === qRound);
            const selectedFile = fileData ? fileData.audio_url : null;
            if (!selectedFile) { window.s2StatusElement.textContent = `‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á S2 Q${qRound} ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!`; return; }

            // ... (Audio playing logic) ...
        }


        // --- DYNAMIC DATA FETCHING (CRITICAL FIX: Use .or() for Single String) ---
        const fetchAllData = async (product) => {
            window.loadingOverlay.style.display = "flex";
            window.loadingText.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${product.toUpperCase()}...`;

            try {
                // üö® CRITICAL FIX: ‡πÉ‡∏ä‡πâ .or() ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö TEXT (String) Column
                const orFilter = `product_type.eq.${product},product_type.eq.all`; 
                let fetches = [];
                
                // 1. Config (No product filter)
                fetches.push(window.supabase.from('difficulty_config').select('*').then(r => dataStore.config = r.data.reduce((acc, c) => ({ ...acc, [c.difficulty_level]: c }), {})));

                // 2. S1 (Customer Replies)
                fetches.push(window.supabase.from('customer_replies_s1').select('*').or(orFilter).order('turn_index', { ascending: true }).then(r => dataStore.s1Files = r.data));

                // 3. S2 (Questions)
                fetches.push(window.supabase.from('questions_s2').select('*').or(orFilter).order('q_index', { ascending: true }).then(r => dataStore.s2Questions = r.data));

                // 4. S3 (Objections)
                fetches.push(window.supabase.from('objections_s3').select('*').or(orFilter).order('ob_index', { ascending: true }).then(r => dataStore.s3Objections = r.data));
                
                // 5. S4 (Health Questions)
                fetches.push(window.supabase.from('health_questions_s4').select('*').or(orFilter).order('q_index', { ascending: true }).then(r => {
                     dataStore.s4HealthQuestions = r.data;
                     dataStore.yesTriggerQ = r.data.find(q => q.is_yes_trigger && (q.product_type === product || q.product_type === 'all'));
                }));
                
                // 6. S4 Follow Up Names
                fetches.push(window.supabase.from('s4_follow_up_names').select('*').or(orFilter).order('step_index', { ascending: true }).then(r => dataStore.s4FollowUpNames = r.data));
                
                // 7. S4 Follow Up Replies
                fetches.push(window.supabase.from('s4_follow_up_replies').select('*').or(orFilter).order('step_index', { ascending: true }).then(r => dataStore.s4FollowUpReplies = r.data));
                
                // 8. S5 (Registration Scripts)
                fetches.push(window.supabase.from('scripts_s5').select('*').or(orFilter).order('step_index', { ascending: true }).then(r => dataStore.s5Scripts = r.data));

                await Promise.all(fetches);

                window.loadingText.textContent = `‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á...`;
                preloadCriticalAudio();
                
                window.loadingOverlay.style.display = "none";
                return true;

            } catch (error) {
                window.loadingText.textContent = `‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö RLS Policy ‡πÅ‡∏•‡∏∞‡∏ß‡πà‡∏≤ product_type ‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô TEXT (String) ‡πÅ‡∏•‡πâ‡∏ß`;
                console.error("Fetch Data Error:", error);
                alert(`‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}.`);
                return false;
            }
        };

        // --- Initialization and Event Listeners ---
        const initializeUserAndDOM = function() {
            // 1. Assign User ID
            let userId = localStorage.getItem(USER_ID_KEY);
            if (!userId) {
                userId = uuidv4();
                localStorage.setItem(USER_ID_KEY, userId);
            }
            currentUserId = userId;
            
            // 2. DOM Element Assignments (Sections)
            window.registrationSection = document.getElementById("registrationSection");
            window.testSection = document.getElementById("testSection");
            /* ... (Assign other DOM elements) ... */
            
            // 3. Bind Event Listeners
            /* ... (Bind listeners to startTest, toggleRecording, flow functions) ... */
        }

        const startTest = async function() {
            const userName = window.inputUserName.value.trim();
            const userGroup = window.inputUserGroup.value;

            if (!userName || !userGroup) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö");
                return;
            }
            
            // üö® CRITICAL: Fetch Data before starting the test!
            const success = await fetchAllData(PRODUCT_ID);
            if (!success) return;

            const selectedDifficulty = document.querySelector('input[name="difficulty"]:checked').value;
            const config = dataStore.config[selectedDifficulty];

            if (!config) {
                 alert(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Difficulty Level: ${selectedDifficulty} ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á difficulty_config`);
                 window.loadingOverlay.style.display = "none";
                 return;
            }

            maxTurns = config.max_s1; maxQ = config.max_s2; maxC = config.max_s3; maxH = config.max_s4; maxA = config.max_s5; 
            /* ... (Set UI spans) ... */

            window.registrationSection.style.display = 'none';
            window.testSection.style.display = 'block';
            
            window.recordBtn.disabled = false;
            window.s1StatusElement.textContent = `üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡∏û‡∏π‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß (‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà 1/${maxTurns})`;
        }

        document.addEventListener('DOMContentLoaded', initializeUserAndDOM);
        
    </script>
</body>
</html>
