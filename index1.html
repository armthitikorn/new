<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>E-Simulator Roleplay (‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û)</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { 
            font-family: 'Sarabun', sans-serif;
            padding: 20px; 
            text-align: center; 
            background-color: #f4f7f6;
        }
        .container-box {
            max-width: 700px; 
            margin: 0 auto; 
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }
        h1 { 
            font-size: 32px;
            color: #d9534f;
            margin-bottom: 20px;
        }
        h2 { 
            margin-top: 25px;
            font-size: 24px;
            color: #337ab7;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            text-align: left;
        }
        .status-bar {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 16px;
            text-align: center;
        }
        .loading-text { color: orange; background-color: #fff3cd; border: 1px solid #ffeeba; }
        .success-text { color: green; background-color: #d4edda; border: 1px solid #c3e6cb; }
        .error-text { color: red; background-color: #f8d7da; border: 1px solid #f5c6cb; }

        /* Recording Section */
        #recordBtn {
            padding: 15px 30px;
            font-size: 18px;
            background-color: #d9534f;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 15px;
        }
        #recordBtn:hover {
            background-color: #c9302c;
        }
        #recordBtn[disabled] {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* Customer Reply Section */
        #customerReply {
            border: 1px solid #ccc;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            text-align: left;
            background-color: #f9f9f9;
        }
        #customerReply h3 {
            color: #333;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 18px;
        }
        #customerAudio {
            width: 100%;
            margin-top: 10px;
        }
        #responseText {
            font-style: italic;
            color: #555;
            min-height: 20px;
            margin-top: 10px;
        }

        /* Detail Boxes */
        .info-box {
            background-color: #f0f8ff;
            border: 1px solid #b0e0e6;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            text-align: left;
        }
        .info-box strong {
            color: #007bff;
        }

        /* Difficulty Radio Styles */
        .difficulty-option {
            margin: 10px 0;
            text-align: left;
        }
        .difficulty-option input {
            margin-right: 10px;
        }
    </style>
</head>
<body>

<div class="container-box">
    <h1>E-Simulator Roleplay ü©∫</h1>
    <h2 id="productNameDisplay">...</h2>

    <div id="registrationSection">
        <div class="info-box">
            <strong>‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå:</strong> <span id="productNameDisplayInfo">...</span><br>
            <strong>‡∏ä‡∏∑‡πà‡∏≠/‡∏£‡∏´‡∏±‡∏™:</strong> <span id="userNameDisplay">...</span><br>
            <strong>‡πÅ‡∏ú‡∏ô‡∏Å:</strong> <span id="departmentDisplay">...</span>
        </div>
        
        <h2>0. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å</h2>
        <div id="difficultyOptions">
            <div class="difficulty-option">
                <input type="radio" id="easy" name="difficulty" value="EASY" checked>
                <label for="easy">EASY (‡∏™‡∏±‡πâ‡∏ô)</label>
            </div>
            <div class="difficulty-option">
                <input type="radio" id="medium" name="difficulty" value="MEDIUM">
                <label for="medium">MEDIUM (‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á)</label>
            </div>
            <div class="difficulty-option">
                <input type="radio" id="hard" name="difficulty" value="HARD">
                <label for="hard">HARD (‡∏¢‡∏≤‡∏ß)</label>
            </div>
        </div>
        <button id="startTestBtn" disabled>‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
    </div>
    
    <div id="testSection" style="display: none;">
        
        <div class="status-bar" id="s1StatusElement"></div>

        <div class="info-box">
            <strong>‡∏£‡∏≠‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (S1/S2/S3/S4/S5):</strong> 
            <span id="maxTurnSpan">0</span> / 
            <span id="maxQSpan">0</span> / 
            <span id="maxCSpan">0</span> / 
            <span id="maxHSpan">0</span> / 
            <span id="maxASpan">0</span>
        </div>
        
        <div id="customerReply">
            <h3>‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</h3>
            <p id="responseText">‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</p>
            <audio id="customerAudio" controls autoplay></audio>
        </div>

        <button id="recordBtn">üî¥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <p id="recordingStatus" style="color: blue; margin-top: 10px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏û‡∏£‡πâ‡∏≠‡∏°</p>
        
        <hr style="margin-top: 20px;">
        
        <div id="section1Div"><h2>1. ‡∏ö‡∏ó‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏™‡∏≤‡∏¢ (S1)</h2></div>
        <div id="section1_5Div" style="display:none;"><h2>1.5 ‡∏ö‡∏ó‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (S1.5)</h2></div>
        <div id="section2Div" style="display:none;"><h2>2. ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (S2)</h2></div>
        <div id="section3Div" style="display:none;"><h2>3. ‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á (S3)</h2></div>
        <div id="section4Div" style="display:none;"><h2>4. ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (S4)</h2></div>
        <div id="section5Div" style="display:none;"><h2>5. ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (S5)</h2></div>

        <a href="index.html" style="display:block; margin-top: 20px;">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
    </div>
</div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    
    // ** 1. Supabase Configuration **
    const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
    // üö® ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Environment Variables ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏Æ‡∏≤‡∏£‡πå‡∏î‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ñ‡∏µ‡∏¢‡πå‡πÉ‡∏ô Production
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
    window.supabase = createClient(supabaseUrl, supabaseKey);

    // Global State
    const CURRENT_PRODUCT_ID = localStorage.getItem('roleplaySelectedProduct') || 'health'; 
    let userData = {};
    
    // üö® DEFAULT/FALLBACK CONFIG 
    let difficultyConfig = {
        EASY: { S1: 3, S2: 5, S3: 3, S4: 5, S5: 7, label: "‡∏á‡πà‡∏≤‡∏¢ (Easy)" }, 
        MEDIUM: { S1: 5, S2: 8, S3: 8, S4: 5, S5: 7, label: "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (Medium)" }, 
        HARD: { S1: 10, S2: 10, S3: 10, S4: 5, S5: 7, label: "‡∏¢‡∏≤‡∏Å (Hard)" } 
    };

    // Global Data Stores (‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Supabase ‡∏´‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)
    let s1Turns = [];
    let s2Questions = [];
    let s3Objections = [];
    let s4HealthQuestions = [];
    let s4FollowUpNames = [];
    let s4FollowUpReplies = [];
    let s5Scripts = [];
    let yesTriggerQ = null;

    let currentTurnIndex = 0;
    let maxTurns = 0;
    let maxQ = 0;
    let maxC = 0;
    let maxH = 0;
    let maxA = 0;
    
    // ** ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞ Section ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô **
    let mediaRecorder;
    let audioChunks = [];
    let currentSection = 'S1'; // S1, S2, S3, S4, S5
    let currentTurnData = null; // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    
    // DOM Elements (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á)
    window.loadingText = document.getElementById('s1StatusElement');
    const recordBtn = document.getElementById('recordBtn');
    const customerAudio = document.getElementById('customerAudio');
    const responseText = document.getElementById('responseText');
    const recordingStatus = document.getElementById('recordingStatus');
    
    // --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (READ) - ‡πÉ‡∏ä‡πâ .or() ---
    const fetchInitialData = async () => {
        window.loadingText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Supabase...';
        window.loadingText.className = 'loading-text';
        let isSuccess = true;

        try {
            const orFilter = `product_type.eq.${CURRENT_PRODUCT_ID},product_type.eq.all`;
            
            // 2.0 Config 
            const { data: cData, error: cError } = await window.supabase.from('difficulty_config').select('*');
            if (cError) throw cError;
            
            if (cData && cData.length > 0) {
                 difficultyConfig = {}; // Clear default config
                 cData.forEach(c => difficultyConfig[c.difficulty_level.toUpperCase()] = { S1: c.max_s1, S2: c.max_s2, S3: c.max_s3, S4: c.max_s4, S5: c.max_s5 });
            }
            
            // 2.1 S1 Customer Replies
            const { data: s1Data, error: s1Error } = await window.supabase
                .from('customer_replies_s1')
                .select('turn_index, audio_url, is_finale')
                .or(orFilter) 
                .order('turn_index', { ascending: true });
            if (s1Error) throw s1Error;
            s1Turns = s1Data;
            
            // ** NOTE: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• S2-S5 ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ä‡πà‡∏ô‡∏Å‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏∞‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö **
            // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡πÇ‡∏´‡∏•‡∏î S2, S3, S4, S5 ‡πÄ‡∏î‡∏¥‡∏°) ...
            
        } catch (err) {
            console.error('Fetch error:', err);
            window.loadingText.textContent = `‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å: ${err.message}. (‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)`;
            window.loadingText.className = 'error-text';
            isSuccess = false;
        }

        if (isSuccess && s1Turns.length > 0) {
            window.loadingText.textContent = '‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å';
            window.loadingText.className = 'success-text';
            document.getElementById('startTestBtn').disabled = false;
        } else {
            // ‡∏´‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î S1 ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ Default Config
            window.loadingText.textContent = `‚ö†Ô∏è ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• S1 ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (0 ‡πÑ‡∏ü‡∏•‡πå) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö RLS Policy! ‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô`;
            window.loadingText.className = 'error-text';
            document.getElementById('startTestBtn').disabled = false; // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ default
        }
    };

    // --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Initialize) ---
    const initializeUserAndDOM = () => {
        const storedUserData = localStorage.getItem('roleplayUserData');
        if (!storedUserData) {
            alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å");
            window.location.href = 'index.html';
            return;
        }
        userData = JSON.parse(storedUserData);
        document.getElementById('userNameDisplay').textContent = userData.fullName || 'N/A';
        document.getElementById('departmentDisplay').textContent = userData.department || 'N/A';
        document.getElementById('productNameDisplay').textContent = `‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå: ${CURRENT_PRODUCT_ID.toUpperCase()}`;
        document.getElementById('productNameDisplayInfo').textContent = CURRENT_PRODUCT_ID.toUpperCase();
        
        // üö® BIND EVENT LISTENER HERE
        document.getElementById('startTestBtn').addEventListener('click', startTest);
        recordBtn.addEventListener('click', toggleRecording);
        
        fetchInitialData();
    };

    // --- 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö (Start Test) ---
    window.startTest = function() {
        const selectedDifficulty = document.querySelector('input[name="difficulty"]:checked').value;
        const config = difficultyConfig[selectedDifficulty]; 

        if (!config) {
            alert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Difficulty Config ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà');
            return;
        }

        maxTurns = config.S1;
        maxQ = config.S2;
        maxC = config.S3;
        maxH = config.S4;
        maxA = config.S5; 
        
        document.getElementById('maxTurnSpan').textContent = maxTurns;
        document.getElementById('maxQSpan').textContent = maxQ;
        document.getElementById('maxCSpan').textContent = maxC;
        document.getElementById('maxHSpan').textContent = maxH;
        document.getElementById('maxASpan').textContent = maxA; 

        document.getElementById('registrationSection').style.display = 'none';
        document.getElementById('testSection').style.display = 'block';

        // üö® ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Section 1
        currentSection = 'S1';
        currentTurnIndex = 0;
        document.getElementById('section1Div').style.display = 'block';
        document.getElementById('section1_5Div').style.display = 'none';
        document.getElementById('section2Div').style.display = 'none';
        document.getElementById('section3Div').style.display = 'none';
        document.getElementById('section4Div').style.display = 'none';
        document.getElementById('section5Div').style.display = 'none';

        // üö® ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡πÅ‡∏£‡∏Å (‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏π‡∏î‡∏Å‡πà‡∏≠‡∏ô)
        nextTurn(true); 
    }
    
    // --- 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (MediaRecorder Logic) ---
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    const toggleRecording = async () => {
        if (!mediaRecorder || mediaRecorder.state === 'inactive') {
            await startRecording();
        } else if (mediaRecorder.state === 'recording') {
            stopRecording();
        }
    };

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    const startRecording = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' }); // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Type ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ
            audioChunks = [];

            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                recordingStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå...';
                recordingStatus.style.color = 'orange';
                
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                
                // üö® ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î (‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î)
                const uploadSuccess = await uploadAudioToSupabase(audioBlob); 
                
                if (uploadSuccess) {
                    // ‡∏´‡∏≤‡∏Å‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö)
                    nextTurn(); 
                } else {
                    recordingStatus.textContent = '‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                    recordingStatus.style.color = 'red';
                    recordBtn.disabled = false;
                    recordBtn.textContent = 'üî¥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
                }
            };

            mediaRecorder.start();
            recordingStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å... üî¥';
            recordingStatus.style.color = 'red';
            recordBtn.textContent = '‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á';

        } catch (err) {
            console.error('Error accessing microphone:', err);
            recordingStatus.textContent = `‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô: ${err.name} (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå)`;
            recordingStatus.style.color = 'red';
        }
    };

    // ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    const stopRecording = () => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            recordBtn.disabled = true; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥‡∏Ç‡∏ì‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
            recordBtn.textContent = '...‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
        }
    };

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Placeholder ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î (‡πÉ‡∏ä‡πâ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô)
    const uploadAudioToSupabase = async (audioBlob) => {
        // ** ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ Logic ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Supabase Storage **
        console.log(`[SIMULATE] ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏ô‡∏≤‡∏î ${audioBlob.size} bytes`);
        
        // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÉ‡∏ô 1.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        await new Promise(resolve => setTimeout(resolve, 1500)); 
        return true; 
    };
    
    // --- 6. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô (Next Turn Logic) ---
    
    // isInitial: true ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á S1 (‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏π‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡∏Å‡πà‡∏≠‡∏ô)
    const nextTurn = (isInitial = false) => {
        
        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Section ‡∏´‡∏≤‡∏Å‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (S1 -> S2)
        if (currentSection === 'S1' && currentTurnIndex >= maxTurns) {
            console.log('--- END S1, START S2 ---');
            currentSection = 'S2';
            currentTurnIndex = 0;
            document.getElementById('section1Div').style.display = 'none';
            document.getElementById('section2Div').style.display = 'block';
            
            // üö® ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° Logic ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ S2 (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏£‡∏Å) ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
            recordingStatus.textContent = '‚úÖ ‡∏ú‡πà‡∏≤‡∏ô S1 ‡πÅ‡∏•‡πâ‡∏ß! ‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
            recordingStatus.style.color = 'green';
            recordBtn.disabled = false;
            recordBtn.textContent = 'üî¥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
            return;
        }
        
        // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô S1
        if (currentSection === 'S1') {
            if (isInitial) {
                // ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô 0: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏π‡∏î‡∏Å‡πà‡∏≠‡∏ô
                customerAudio.style.display = 'none';
                responseText.textContent = '‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤';
                recordBtn.textContent = 'üî¥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
                recordBtn.disabled = false;
                recordingStatus.textContent = `üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡∏û‡∏π‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß (‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà 1/${maxTurns})`;
                recordingStatus.style.color = 'blue';
                currentTurnIndex++;
                return;
            }
            
            // ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô 1, 2, ... : ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö
            if (currentTurnIndex - 1 < s1Turns.length) {
                currentTurnData = s1Turns[currentTurnIndex - 1];
                
                // 3. ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                customerAudio.src = currentTurnData.audio_url || ''; // ‡πÉ‡∏ä‡πâ URL ‡∏à‡∏≤‡∏Å Supabase
                customerAudio.style.display = 'block';
                responseText.textContent = `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö (‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà ${currentTurnIndex})...`;
                
                customerAudio.onended = () => {
                    // 4. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° UI ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏π‡∏î‡∏à‡∏ö
                    recordBtn.textContent = 'üî¥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
                    recordBtn.disabled = false;
                    recordingStatus.textContent = `üé§ ‡∏ñ‡∏∂‡∏á‡∏ï‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏û‡∏π‡∏î‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà ${currentTurnIndex + 1}/${maxTurns})`;
                    recordingStatus.style.color = 'blue';
                    currentTurnIndex++;
                };
            } else {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• S1 ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á maxTurns
                console.warn('S1 Data run out, forcing S2 start.');
                currentTurnIndex = maxTurns; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á maxTurns ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤ Logic S2
                nextTurn(); 
                return;
            }
        } 
        // Note: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Section S2, S3, S4, S5 ‡∏ï‡πà‡∏≠‡πÑ‡∏õ
    };

    document.addEventListener('DOMContentLoaded', initializeUserAndDOM);
</script>
</body>
</html>
